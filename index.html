<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Weather Service</title>
    <script src="config.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Mode (Default) */
            --primary: #ff9f43;
            --primary-hover: #ff7e5f;
            --secondary: #2c3e50;
            --accent: #4facfe;
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --text-main: #2c3e50;
            --text-muted: #6c757d;
            --card-bg: #ffffff;
            --nav-bg: rgba(255, 255, 255, 0.95);
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --input-text: #212529;
            --footer-bg: #f1f5f9; /* Light Footer */
            --footer-text: #2c3e50;
        }

        [data-theme="dark"] {
            /* Dark Mode */
            --primary: #ff9f43;
            --primary-hover: #e67e22;
            --secondary: #ecf0f1;
            --accent: #3498db;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --text-main: #f8f9fa;
            --text-muted: #aab2bd;
            --card-bg: #1e293b; /* Dark Slate */
            --nav-bg: rgba(15, 23, 42, 0.95);
            --input-bg: #334155;
            --input-border: #475569;
            --input-text: #f8f9fa;
            --footer-bg: #0b1120; /* Dark Footer */
            --footer-text: #94a3b8;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-main);
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* Navbar */
        .navbar {
            background: var(--nav-bg);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: background 0.5s ease;
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--primary) !important;
            font-size: 1.5rem;
        }
        .nav-link {
            color: var(--text-main);
            font-weight: 600;
            cursor: pointer;
        }
        .nav-link:hover {
            color: var(--primary);
        }
        
        /* Dark Mode Toggle Btn */
        .theme-toggle-btn {
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: transform 0.3s;
        }
        .theme-toggle-btn:hover {
            transform: rotate(30deg);
            color: var(--primary);
        }

        /* Common Elements */
        h1, h2, h3, h4, h5 {
            color: var(--text-main);
        }
        p, .text-muted {
            color: var(--text-muted) !important;
        }

        /* Cards */
        .plan-card, .feature-box, .form-section {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
            transition: background 0.5s ease, transform 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        /* Dark mode border adjustment for cards */
        [data-theme="dark"] .plan-card, 
        [data-theme="dark"] .feature-box,
        [data-theme="dark"] .form-section {
            border: 1px solid rgba(255,255,255,0.05);
        }

        .plan-header {
            background: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 2.5rem;
            text-align: center;
        }
        [data-theme="dark"] .plan-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .plan-card.max-plan {
            border: 2px solid var(--primary);
        }
        .badge-popular {
            background: var(--primary);
            color: #fff;
            position: absolute;
            top: 15px;
            right: -30px;
            padding: 0.5rem 3rem;
            transform: rotate(45deg);
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            border: none;
            color: #ffffff;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .btn-primary-custom:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(255, 159, 67, 0.4);
             color: #ffffff;
        }
        .btn-outline-custom {
            border: 2px solid var(--text-main);
            color: var(--text-main);
            font-weight: 600;
            background: transparent;
        }
        .btn-outline-custom:hover {
            background: var(--text-main);
            color: var(--card-bg); /* Invert */
        }

        /* Inputs for Dark Mode */
        .form-control, .form-select {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--input-text);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--input-bg);
            color: var(--input-text);
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(255, 159, 67, 0.25);
        }

        /* Forms Container */
        .form-section {
            display: none;
            max-width: 500px;
            margin: 2rem auto;
            padding: 3rem;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Contact Section */
        #contact-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.05);
        }
        
        /* Custom Dashboard Tabs */
        .nav-pills-custom {
            background: rgba(0, 0, 0, 0.05); /* Light mode bg */
            padding: 5px;
            border-radius: 50px;
        }
        [data-theme="dark"] .nav-pills-custom {
            background: rgba(255, 255, 255, 0.05); /* Dark mode bg */
        }
        .nav-pills-custom .nav-link {
            color: var(--text-main); /* Uses theme text color */
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        .nav-pills-custom .nav-link:hover {
            background: rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .nav-pills-custom .nav-link:hover {
            background: rgba(255,255,255,0.05);
        }
        .nav-pills-custom .nav-link.active {
            background-color: var(--primary);
            color: #fff; /* Always white on active */
        }

        /* Hero Animation */
        .hero-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        /* Footer */
        footer {
            background: var(--footer-bg);
            color: var(--footer-text);
            padding: 3rem 0;
            margin-top: 5rem;
            transition: background 0.5s ease, color 0.5s ease;
            border-radius: 24px;
            margin-bottom: 2rem;
        }
        footer h5 { color: var(--text-main); }
        footer a { color: var(--text-muted); text-decoration: none; }
        footer a:hover { color: var(--primary); }

        /* Media Query for Brand Center */
        @media (max-width: 991px) {
            .navbar-brand {
                position: static;
                transform: none;
                left: auto;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="location.reload()">
                <i class="fas fa-sun me-2"></i>Global Weather
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center gap-3">
                    <li class="nav-item"><a class="nav-link" onclick="handleNavClick('landing-page')">Home</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="handleNavClick('features-scroll')">Features</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="handleNavClick('plans-scroll')">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="handleNavClick('contact-scroll')">Contact</a></li>
                    <li class="nav-item"><a href="./Admin.html" class="nav-link text-decoration-underline" >Admin Portal</a></li>
                    
                    <li class="nav-item">
                        <button class="btn btn-primary-custom rounded-pill px-4" onclick="showSection('manage-auth')">
                            Manage
                        </button>
                    </li>

                    <li class="nav-item border-start ps-3 ms-2">
                        <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                            <i class="fas fa-moon" id="theme-icon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px;">

        <div id="landing-page">
            
            <section class="hero-section text-center py-5">
                <div class="row align-items-center">
                    <div class="col-lg-8 mx-auto">
                        <i class="fas fa-cloud-sun-rain hero-icon"></i>
                        <h1 class="display-4 fw-bolder mb-3">Wake Up to the Weather.</h1>
                        <p class="lead mb-5" style="max-width: 600px; margin: 0 auto;">
                            Get automated, precise weather reports delivered to your inbox every morning at 8 AM. 
                            Never get caught in the rain again.
                        </p>
                        <div class="d-flex justify-content-center gap-3">
                            <a onclick="handleNavClick('plans-scroll')" class="btn btn-primary-custom rounded-pill py-2 px-4" style="cursor: pointer;">Get Started</a>
                            <button onclick="showSection('manage-auth')" class="btn btn-outline-custom rounded-pill py-2 px-4">Existing User?</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="features-scroll" class="py-5 mb-5">
                <div class="text-center mb-5">
                    <h2 class="fw-bold">Why Global Weather?</h2>
                    <p class="text-muted">More than just a forecast.</p>
                </div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="feature-box p-4 h-100 text-center">
                            <i class="fas fa-globe-americas fa-3x text-accent mb-3" style="color: var(--accent);"></i>
                            <h4 class="fw-bold">Global Coverage</h4>
                            <p class="text-muted">Tracking weather patterns in New York, Tokyo, London, and beyond.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-box p-4 h-100 text-center">
                            <i class="fas fa-file-pdf fa-3x text-primary mb-3"></i>
                            <h4 class="fw-bold">Detailed Reports</h4>
                            <p class="text-muted">Premium PDF attachments with humidity, wind speed, and weekly outlooks.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-box p-4 h-100 text-center">
                            <i class="fas fa-stopwatch fa-3x text-success mb-3"></i>
                            <h4 class="fw-bold">Precision Timing</h4>
                            <p class="text-muted">Our intelligent scheduler ensures your report arrives exactly at 8 AM.</p>
                        </div>
                    </div>
                </div>
            </section>

            <div id="plans-scroll" class="py-5">
                <div class="text-center mb-5">
                    <h2 class="display-6 fw-bold">Simple Pricing</h2>
                    <p class="text-muted">Choose the plan that fits your lifestyle.</p>
                </div>

                <div class="row g-4 justify-content-center">
                    <div class="col-md-4">
                        <div class="plan-card h-100">
                            <div class="plan-header">
                                <h3 class="fw-bold">GO</h3>
                                <div class="plan-price display-4 fw-bold my-2">Free</div>
                                <span class="badge bg-secondary">Essentials</span>
                            </div>
                            <div class="p-4">
                                <ul class="list-unstyled mb-4">
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Daily Report</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Local Weather</li>
                                    <li class="mb-2 text-muted"><i class="fas fa-times me-2"></i>No International</li>
                                </ul>
                                <button class="btn btn-outline-custom w-100 rounded-pill" onclick="startRegister(0, 'GO')">Select GO</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="plan-card h-100">
                            <div class="plan-header">
                                <h3 class="fw-bold">PRO</h3>
                                <div class="plan-price display-4 fw-bold my-2">$5</div>
                                <span class="badge bg-info text-dark">Traveler</span>
                            </div>
                            <div class="p-4">
                                <ul class="list-unstyled mb-4">
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Daily Report</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Local + International</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Priority Delivery</li>
                                </ul>
                                <button class="btn btn-primary-custom w-100 rounded-pill" onclick="startRegister(1, 'PRO')">Select PRO</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="plan-card max-plan h-100 position-relative">
                            <div class="badge-popular">POPULAR</div>
                            <div class="plan-header">
                                <h3 class="fw-bold text-primary">MAX</h3>
                                <div class="plan-price display-4 fw-bold my-2">$12</div>
                                <span class="badge bg-warning text-dark">Power User</span>
                            </div>
                            <div class="p-4">
                                <ul class="list-unstyled mb-4">
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>2x Daily Reports</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Global Access</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>PDF Attachments</li>
                                </ul>
                                <button class="btn btn-primary-custom w-100 rounded-pill" onclick="startRegister(2, 'MAX')">Select MAX</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <section id="contact-scroll" class="py-5">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div id="contact-section">
                            <div class="text-center mb-4">
                                <h2 class="fw-bold">Contact Us</h2>
                                <p class="text-muted">Have questions? We'd love to hear from you.</p>
                            </div>
                            <form onsubmit="handleContactSubmit(event)">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="contactName" placeholder="Your Name" required>
                                            <label for="contactName">Name</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="email" class="form-control" id="contactEmail" placeholder="name@example.com" required>
                                            <label for="contactEmail">Email</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <textarea class="form-control" placeholder="Leave a comment here" id="contactMessage" style="height: 100px" required></textarea>
                                            <label for="contactMessage">Message</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-primary-custom w-100 py-3 rounded-pill" type="submit">Send Message</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
            
            <footer>
                <div class="container text-center">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <h5 class="fw-bold">Global Weather</h5>
                            <p class="small">Precision weather data for the modern world.</p>
                        </div>
                        <div class="col-md-4 mb-3">
                            <h5 class="fw-bold">Links</h5>
                            <ul class="list-unstyled">
                                <li><a href="#" onclick="handleNavClick('features-scroll')">Features</a></li>
                                <li><a href="#" onclick="handleNavClick('plans-scroll')">Pricing</a></li>
                                <li><a href="#" onclick="handleNavClick('contact-scroll')">Contact</a></li>
                            </ul>
                        </div>
                        <div class="col-md-4 mb-3">
                            <h5 class="fw-bold">Connect</h5>
                            <p class="small">support@globalweather.com<br>1-800-WEATHER</p>
                        </div>
                    </div>
                    <hr class="border-secondary mt-4">
                    <p class="small mb-0 opacity-50">&copy; 2025 Global Weather Service. All rights reserved.</p>
                </div>
            </footer>
        </div>
        <div id="register-section" class="form-section">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <h3 class="fw-bold m-0">Sign Up for <span id="display-plan-name" class="text-primary"></span></h3>
                <button type="button" class="btn-close shadow-none" onclick="showSection('landing-page')"></button>
            </div>
            <form onsubmit="handleRegistration(event)">
                <div class="form-floating mb-3">
                    <input type="text" id="reg-name" class="form-control rounded-4" placeholder="Full Name" required>
                    <label for="reg-name">Full Name</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="email" id="reg-email" class="form-control rounded-4" placeholder="name@example.com" required>
                    <label for="reg-email">Email Address</label>
                </div>
                <div class="form-floating mb-4">
                    <input type="tel" id="reg-phone" class="form-control rounded-4" placeholder="Mobile Number" required>
                    <label for="reg-phone">Mobile Number</label>
                </div>
                <input type="hidden" id="reg-sub-type">
                
                <button type="submit" class="btn btn-primary-custom rounded-pill py-3 w-100">
                    <span id="reg-btn-text">Proceed to Verification</span>
                    <span id="reg-spinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                </button>
            </form>
        </div>

        <div id="otp-section" class="form-section text-center">
            <div class="mb-4">
                <span class="fa-stack fa-3x text-primary">
                  <i class="fas fa-circle fa-stack-2x opacity-25"></i>
                  <i class="fas fa-shield-alt fa-stack-1x"></i>
                </span>
            </div>
            <h3 class="fw-bold">Verify Your Email</h3>
            <p class="text-muted mb-5">We've sent a 6-digit code to <br><strong id="otp-email-display"></strong></p>
            
            <div class="d-flex justify-content-center mb-5">
                <input type="text" id="otp-input" class="form-control form-control-lg text-center fw-bold text-primary rounded-4" style="width: 200px; letter-spacing: 8px; font-size: 1.5rem;" placeholder="••••••" maxlength="6">
            </div>

            <button onclick="verifyOtp()" class="btn btn-primary-custom rounded-pill py-3 w-100 mb-3">Verify & Activate</button>
            <button onclick="showSection('register-section')" class="btn btn-link text-muted text-decoration-none">Back to Registration</button>
        </div>

        <div id="manage-auth" class="form-section text-center">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <h3 class="fw-bold m-0">Manage Subscription</h3>
                <button type="button" class="btn-close shadow-none" onclick="showSection('landing-page')"></button>
            </div>
            <p class="text-muted mb-5">Enter your registered email address to access your dashboard.</p>
            
            <div class="form-floating mb-4 text-start">
                <input type="email" id="manage-email-input" class="form-control rounded-4" placeholder="name@example.com" required>
                 <label for="manage-email-input">Registered Email</label>
            </div>
            <button onclick="authenticateManager()" class="btn btn-primary-custom rounded-pill py-3 w-100">Access Dashboard</button>
        </div>

        <div id="manage-dashboard" class="form-section" style="max-width: 600px;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold m-0">User Dashboard</h3>
                <button type="button" class="btn-close shadow-none" onclick="showSection('landing-page')"></button>
            </div>
            
            <div class="d-flex align-items-center p-3 bg-primary bg-opacity-10 rounded-4 mb-4">
                <div class="flex-shrink-0">
                      <i class="fas fa-user-circle fa-2x text-primary"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h5 class="mb-0" id="dashboard-email-title">user@example.com</h5>
                    <small class="text-muted">Logged in</small>
                </div>
            </div>

            <ul class="nav nav-pills nav-pills-custom nav-fill mb-4 gap-2" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fw-bold" data-bs-toggle="pill" data-bs-target="#pills-profile">Update Details</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#pills-plan">Change Plan</button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-profile">
                    <form onsubmit="handleProfileUpdate(event)">
                        <div class="form-floating mb-3">
                            <input type="text" id="update-name" class="form-control rounded-4" placeholder="Name">
                            <label for="update-name">Name</label>
                        </div>
                        <div class="form-floating mb-4">
                            <input type="tel" id="update-phone" class="form-control rounded-4" placeholder="Mobile Number">
                            <label for="update-phone">Mobile Number</label>
                        </div>
                        <button type="submit" class="btn btn-primary-custom rounded-pill py-3 w-100">Save Changes</button>
                    </form>
                </div>

                <div class="tab-pane fade" id="pills-plan">
                     <div class="form-floating mb-4">
                        <select class="form-select rounded-4 fw-bold" id="patch-sub-select" aria-label="Select Plan">
                            <option value="0">GO</option>
                            <option value="1">PRO</option>
                            <option value="2">MAX</option>
                        </select>
                        <label for="patch-sub-select">New Plan</label>
                    </div>
                    
                    <button onclick="handlePatchSubscription()" class="btn btn-primary-custom rounded-pill py-3 w-100 mb-4">Update Plan</button>
                    
                    <hr class="text-muted opacity-25 my-4">
                    
                    <button onclick="handleDeleteUser()" class="btn btn-outline-danger rounded-pill py-3 w-100 fw-bold">
                        <i class="fas fa-trash-alt me-2"></i>Unsubscribe & Delete
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // CONFIG
        const API_URL = window.APP_CONFIG.API_BASE_URL+"/client";
        console.log(API_URL);
        let tempEmail = ""; 
        let currentManageEmail = "";

        // --- HELPER: Parse ResponseStructure ---
        async function parseResponse(response) {
            try {
                const data = await response.json();
                
                // CASE 1: Standard Success (ResponseStructure)
                if (data.hasOwnProperty('statusCode') && data.hasOwnProperty('status')) {
                     
                     // Handle Logic: status=false inside 200/404
                     if (data.status === false) {
                         return {
                             success: false,
                             message: (typeof data.payload === 'string') ? data.payload : "Operation Failed",
                             payload: null
                         };
                     }

                     return {
                        success: true,
                        // If payload is a string (message), use it. Else use "Operation Completed"
                        message: (typeof data.payload === 'string') ? data.payload : (data.type || "Operation Completed"),
                        payload: data.payload,
                        raw: data
                    };
                }
                
                // CASE 2: Validation Errors (Map like {"phoneNumber": "Invalid..."})
                // Heuristic: No 'statusCode' key, but has other keys
                const keys = Object.keys(data);
                if (keys.length > 0 && !data.hasOwnProperty('statusCode')) {
                    // Convert map to string: "phoneNumber: Invalid Mobile Number"
                    const errorMessages = keys.map(key => `${key}: ${data[key]}`).join('\n');
                    return {
                        success: false,
                        message: "Validation Error:\n" + errorMessages,
                        payload: null
                    };
                }

                // Fallback for unexpected format
                return {
                    success: response.ok,
                    message: response.statusText,
                    payload: null,
                    raw: data
                };

            } catch (error) {
                // If JSON parsing fails
                return {
                    success: false,
                    message: "Server Error (Invalid JSON response)",
                    payload: null
                };
            }
        }


        // --- DARK MODE LOGIC ---
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Initialize Theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        if(savedTheme === 'dark') {
            document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
        }

        // --- CONTACT FORM LOGIC ---
       async function handleContactSubmit(e) {
            e.preventDefault();
            const name =  document.getElementById("contactName").value
            const email =  document.getElementById("contactEmail").value
            const message =  document.getElementById("contactMessage").value

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            
            btn.innerText = "Sending...";
            btn.disabled = true;
                     
        try {
             const res = await fetch("https://formspree.io/f/mldpdyev", {
             method: "POST",
             headers: {
               "Content-Type": "application/json"
            },
            body: JSON.stringify({name,email,message})
         });

       if (res.ok) {
            alert("Thank you for your message! We will get back to you shortly.");
            e.target.reset();
        }else {
           alert("Something went wrong. Please try again.");
         }
        } catch (err) {
          alert("Network error! Please check your connection.");
         }
            btn.innerText = originalText;
            btn.disabled = false;
        };

        // --- NAVIGATION HELPERS ---
        
        // NEW FUNCTION: Closes the mobile navbar if open
        function closeMobileMenu() {
            const navBar = document.getElementById('navbarNav');
            // Check if navbar exists and is expanded (has 'show' class)
            if (navBar && navBar.classList.contains('show')) {
                // Get or create the Bootstrap Collapse instance
                let bsCollapse = bootstrap.Collapse.getInstance(navBar);
                if (!bsCollapse) {
                    bsCollapse = new bootstrap.Collapse(navBar, { toggle: false });
                }
                // Hide (collapse) the navbar
                bsCollapse.hide();
            }
        }

        function showSection(id) {
            // Close menu first if open
            closeMobileMenu();

            document.getElementById('landing-page').style.display = 'none';
            document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- NAVIGATION HANDLER ---
        function handleNavClick(sectionId) {
            // Close mobile menu first
            closeMobileMenu();

            // 1. Ensure Landing Page is visible
            showSection('landing-page');
            
            // 2. If it's just home, stop here (already scrolled to top by showSection)
            if (sectionId === 'landing-page') return;

            // 3. Scroll to the specific section after a tiny delay to ensure visibility
            setTimeout(() => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth' });
                }
            }, 50); 
        }

        // --- 1. REGISTRATION FLOW ---
        function startRegister(planValue, planName) {
            document.getElementById('display-plan-name').innerText = planName;
            document.getElementById('reg-sub-type').value = planValue;
            showSection('register-section');
        }

        async function handleRegistration(e) {
            e.preventDefault();
            
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const phone = document.getElementById('reg-phone').value;
            const subType = parseInt(document.getElementById('reg-sub-type').value);

            // Using 'phoneNumber' to match your Curl
            const payload = {
                name: name,
                email: email,
                subscriptionType: subType,
                phoneNumber: phone 
            };

            const btn = document.querySelector('#register-section button[type="submit"]');
            const spinner = document.getElementById('reg-spinner');
            const btnText = document.getElementById('reg-btn-text');
            
            try {
                btn.disabled = true;
                spinner.classList.remove('d-none');
                btnText.textContent = "Processing...";

                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await parseResponse(response);

                if (result.success) {
                    tempEmail = email;
                    document.getElementById('otp-email-display').innerText = email;
                    showSection('otp-section');
                    // Alert the payload message (e.g. "Otp send successfully...")
                    alert(result.message); 
                } else {
                    console.log(result);
                    alert(result.message); // Shows validation errors or status:false message
                }
            } catch (error) {
                console.error(error);
                alert("Server connection failed. Is the API running?");
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
                btnText.textContent = "Proceed to Verification";
            }
        }

        // --- 2. OTP VERIFICATION ---
        async function verifyOtp() {
            const otpInput = document.getElementById('otp-input');
            const otp = otpInput.value;
            
            try {
                const response = await fetch(`${API_URL}/verify-otp?email=${encodeURIComponent(tempEmail)}&otp=${otp}`, {
                    method: 'POST'
                });
                
                const result = await parseResponse(response);

                if (result.success) {
                    alert(result.message); // "OTP validated successfully"
                    window.location.reload(); 
                } else {
                    alert("Verification Failed: " + result.message);
                    otpInput.value = '';
                }
            } catch (error) {
                alert("Verification failed. Check connection.");
            }
        }

        // --- 3. MANAGEMENT FLOW ---
        
        let subcode;
        async function authenticateManager() {
            const emailInput = document.getElementById('manage-email-input');
            const email = emailInput.value;
            if(!email || !email.includes('@')) {
                alert("Please enter a valid email address.");
                return;
            }
            currentManageEmail = email;
            document.getElementById('dashboard-email-title').innerText = email;
            
            const response = await fetch(`${API_URL}/${email}`, {method: 'GET'});
            const result = await parseResponse(response);
            
            if(!result.success) {
                alert("Error fetching Client: " + result.message);
                return;
            }
            
            subcode = result.payload.subscriptionType;
            
            showSection('manage-dashboard');
            document.getElementById('update-name').value = result.payload.name;
            document.getElementById('update-phone').value = result.payload.phoneNumber;
            
            // Logic to select current plan and add text "(Current)"
            const select = document.getElementById("patch-sub-select");
            
            // 1. Clean previous "Current" labels
            Array.from(select.options).forEach(opt => {
                opt.text = opt.text.replace(" (Current)", "");
            });

            // 2. Set Value
            select.value = subcode;

            // 3. Add Label to active option
            const selectedOption = select.options[select.selectedIndex];
            if(selectedOption) {
                selectedOption.text += " (Current)";
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const name = document.getElementById('update-name').value;
            const mobile = document.getElementById('update-phone').value;
            // Using 'mobileNumber' and 'subscrptionType' (check backend spelling) 
            // per your PUT Curl example.
            const payload = {
                name: name,
                mobileNumber: mobile, 
            };

            try {
                const response = await fetch(`${API_URL}/${currentManageEmail}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await parseResponse(response);
                
                if(result.success) {
                    // Success payload is an object { UpdatedData: {...} }
                    // We just show a success message
                    alert("Profile Updated Successfully!");
                } else {
                     alert("Update failed: " + result.message);
                }
            } catch(err) { 
                alert("Error connecting to server " + err.message); 
            }
        }

        async function handlePatchSubscription() {
            const newType = document.getElementById('patch-sub-select').value;
            try {
                const response = await fetch(`${API_URL}/${currentManageEmail}/subscription?subscriptionId=${newType}`, {
                    method: 'PATCH'
                });
                
                const result = await parseResponse(response);

                if(result.success) {
                    alert("Plan Updated Successfully");
                    // Refresh view to update "(Current)" text
                    authenticateManager(); 
                }
                else {
                    // Handles the "Client is inactive" 404/false case
                    alert("Failed: " + result.message);
                }
            } catch(err) { alert("Error connecting to server"); }
        }

        async function handleDeleteUser() {
            if(!confirm("Are you sure? This will delete your account permanently.")) return;

            try {
                const response = await fetch(`${API_URL}/${currentManageEmail}`, {
                    method: 'DELETE' 
                });
                
                const result = await parseResponse(response);

                if(result.success) {
                    alert(result.message); // "Client deleted successfully"
                    window.location.reload();
                } else {
                    alert("Error: " + result.message);
                }
            } catch(err) { alert("Error connecting to server"); }
        }
    </script>
</body>
</html>